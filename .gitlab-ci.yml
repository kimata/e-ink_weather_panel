image: docker:23.0

stages:
  - test
  - build
  - deploy

# サンプル設定ファイルで，問題なく動くかチェック
test-sample:
  stage: test
    
  script:
    - docker build . -t ${CI_REGISTRY_IMAGE}
    - docker run -t ${CI_REGISTRY_IMAGE} src/create_image.py -f config.example.yaml > /dev/null

# 本番設定ファイルで，問題なく動くかチェック
build-image:
  stage: build
  image: ubuntu:22.04

  script:
    - apt update
    - apt install -y docker.io git
    - export GIT_SSL_NO_VERIFY=1
    - git clone https://gitlab.green-rabbit.net/kimata/panel_config.git
    - mv panel_config/e-ink_weather.yaml config.yaml
    - mkdir key
    - mv panel_config/panel.id_rsa key
    - rm -rf font
    - git clone https://gitlab.green-rabbit.net/kimata/font.git
    - docker build . -t ${CI_REGISTRY_IMAGE}
    - docker run -t ${CI_REGISTRY_IMAGE} src/create_image.py -f config.yaml > /dev/null
    - docker push ${CI_REGISTRY_IMAGE}

deploy:
  stage: deploy
  image:
    name: registry.green-rabbit.net/library/kubectl_image:latest
    entrypoint: ['']
  script:
#    - kubectl config set-cluster gitlab --certificate-authority="${CA_CERT}"
    - cat /builds/kimata/e-ink_weather_panel.tmp/KUBECONFIG
    - kubectl config get-contexts
    - kubectl config use-context kimata/e-ink_weather_panel:pod-rollout 
    - kubectl get pods -A -v=10
    # - kubectl --insecure-skip-tls-verify=true get pods -A -v=10















