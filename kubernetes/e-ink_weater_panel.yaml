apiVersion: apps/v1
kind: Deployment
metadata:
    name: e-ink-weather-panel-deployment
    namespace: panel
    labels:
        app: e-ink-weather-panel
spec:
    replicas: 1
    selector:
        matchLabels:
            app: e-ink-weather-panel
    template:
        metadata:
            labels:
                app: e-ink-weather-panel
        spec:
            containers:
                - name: e-ink-weather-panel
                  image: registry.green-rabbit.net:5000/kimata/e-ink_weather_panel:latest
                  imagePullPolicy: Always
                  env:
                    - name: RASP_HOSTNAME
                      value: rasp-meter-1
                    - name: INFLUXDB_TOKEN
                      valueFrom:
                        secretKeyRef:
                            name: influxdb-token
                            key: password
                  resources:
                    requests:
                        memory: 512Mi
                        ephemeral-storage: 256Mi
                    limits:
                        memory: 2Gi
                        ephemeral-storage: 1Gi
                  livenessProbe:
                    exec:
                        command:
                            - /opt/e-ink_weather/src/healthz.py
                    initialDelaySeconds: 120
                    periodSeconds: 60
                    timeoutSeconds: 1
                    successThreshold: 1
                    failureThreshold: 2
            dnsPolicy: Default
            affinity:
                nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                            - matchExpressions:
                                - key: node-role.kubernetes.io/server
                                  operator: In
                                  values:
                                    - large
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: e-ink-weather-small-panel-deployment
    namespace: panel
    labels:
        app: e-ink-weather-small-panel
spec:
    replicas: 1
    selector:
        matchLabels:
            app: e-ink-weather-small-panel
    template:
        metadata:
            labels:
                app: e-ink-weather-small-panel
        spec:
            containers:
                - name: e-ink-weather-panel
                  image: registry.green-rabbit.net:5000/kimata/e-ink_weather_panel:latest
                  imagePullPolicy: Always
                  env:
                    - name: RASP_HOSTNAME
                      value: rasp-display-2
                    - name: INFLUXDB_TOKEN
                      valueFrom:
                        secretKeyRef:
                            name: influxdb-token
                            key: password
                  resources:
                    requests:
                        memory: 512Mi
                        ephemeral-storage: 256Mi
                    limits:
                        memory: 2Gi
                        ephemeral-storage: 1Gi
                  livenessProbe:
                    exec:
                        command:
                            - /opt/e-ink_weather/src/healthz.py
                    initialDelaySeconds: 120
                    periodSeconds: 60
                    timeoutSeconds: 1
                    successThreshold: 1
                    failureThreshold: 2
            dnsPolicy: Default
            affinity:
                nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                            - matchExpressions:
                                - key: node-role.kubernetes.io/server
                                  operator: In
                                  values:
                                    - large
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: e-ink-weather-webapp-deployment
    namespace: panel
    labels:
        app: e-ink-weather-webapp
spec:
    replicas: 1
    selector:
        matchLabels:
            app: e-ink-weather-webapp
    template:
        metadata:
            labels:
                app: e-ink-weather-webapp
        spec:
            containers:
                - name: e-ink-weather-webapp
                  image: registry.green-rabbit.net:5000/kimata/e-ink_weather_panel:latest
                  command: [./src/webapp.py, -c, config-demo.yaml, -d]
                  imagePullPolicy: Always
                  ports:
                    - containerPort: 5000
                  resources:
                    requests:
                        memory: 512Mi
                        ephemeral-storage: 128Mi
                    limits:
                        memory: 1Gi
                        ephemeral-storage: 256Mi
                  livenessProbe:
                    httpGet:
                        port: 5000
                        path: /weather_panel/
                    initialDelaySeconds: 120
                    periodSeconds: 60
                    timeoutSeconds: 1
                    successThreshold: 1
                    failureThreshold: 5
            dnsPolicy: Default
            affinity:
                nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                            - matchExpressions:
                                - key: node-role.kubernetes.io/server
                                  operator: In
                                  values:
                                    - large
---
kind: Service
apiVersion: v1
metadata:
    name: e-ink-weather-webapp
    namespace: panel
    annotations:
        metallb.universe.tf/address-pool: default
        external-dns.alpha.kubernetes.io/hostname: e-ink-weather.kubernetes.green-rabbit.net
spec:
    selector:
        app: e-ink-weather-webapp
    ports:
        - port: 5000
          targetPort: 5000
    type: LoadBalancer
